# ===========================
# HTTP -> HTTPS 리다이렉트
# ===========================
server {
    listen 80;
    server_name studyspot.kr www.studyspot.kr;

    location /stub_status {
        stub_status;
        allow 127.0.0.1;
        allow 172.20.0.0/16;
        deny all;
    }

    return 301 https://$host$request_uri;
}

server {
    listen 80;
    server_name test.studyspot.kr;    

    location /stub_status {
        stub_status;
        allow 127.0.0.1;
        allow 172.20.0.0/16;
        deny all;
    }


    return 301 https://$host$request_uri;
}

server {
    if ($host = hs.studyspot.kr) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name hs.studyspot.kr;
    return 301 https://$host$request_uri;
}

server {
    if ($host = storage.studyspot.kr) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name storage.studyspot.kr;
    return 301 https://$host$request_uri;
}

server {
    if ($host = tmp.studyspot.kr) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name tmp.studyspot.kr;
    return 301 https://$host$request_uri;


}

# ===========================
# Nginx Exporter
# ===========================
server {
    listen 80;
    server_name localhost;

    location /stub_status {
        stub_status;
        allow 127.0.0.1;
        allow 172.20.0.0/16;
        deny all;
    }

    # 다른 요청은 HTTPS로 리다이렉트
    location / {
        return 301 https://$host$request_uri;
    }
}

# ===========================
# 운영 HTTPS
# ===========================
server {
    listen 443 ssl http2;
    server_name studyspot.kr www.studyspot.kr;

    # TLS 인증서
    ssl_certificate /etc/letsencrypt/live/studyspot.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/studyspot.kr/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 공통 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    location / {
        proxy_pass http://localhost:3000;  # frontend 컨테이너
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        rewrite ^/api/(.*)$ /$1 break;  # /api/ 접두어를 제거하고 전달
        proxy_pass http://localhost:8080;  # backend 컨테이너
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # === Nginx Exporter용 상태 엔드포인트 ===
    location /stub_status {
        stub_status;
        allow 127.0.0.1;
        allow 172.20.0.0/16;  # Docker 내부 네트워크 대역
        deny all;
    }
}

# 테스트 HTTPS
server {
    listen 443 ssl http2;
    server_name test.studyspot.kr;

    # TLS 인증서
    ssl_certificate /etc/letsencrypt/live/test.studyspot.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/test.studyspot.kr/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 공통 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    location / {
        proxy_pass http://localhost:3001;  # frontend-test 컨테이너
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        rewrite ^/api/(.*)$ /$1 break;  # /api/ 접두어를 제거하고 전달
        proxy_pass http://localhost:8081;  # backend-test 컨테이너
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # === Nginx Exporter용 상태 엔드포인트 ===
    location /stub_status {
        stub_status;
        allow 127.0.0.1;
        allow 172.20.0.0/16;  # Docker 내부 네트워크 대역
        deny all;
    }
}

# Hoppscotch HTTPS
server {
    listen 443 ssl http2;
    server_name hs.studyspot.kr;

    # TLS 인증서
    ssl_certificate /etc/letsencrypt/live/hs.studyspot.kr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/hs.studyspot.kr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 공통 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Hoppscotch Frontend
    location / {
        proxy_pass http://localhost:8003;  # frontend 컨테이너
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
		
    # Hoppscotch Backend
    location /backend/ {
        proxy_pass http://localhost:3200/backend/;  # backend 컨테이너
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
		
    # Hoppscotch Admin
    location /admin/ {
        proxy_pass http://localhost:8300/admin/;  # admin 컨테이너
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===========================
# MinIO HTTPS (API ONLY)
# ===========================
server {
    listen 443 ssl http2;
    server_name storage.studyspot.kr;

    # TLS 인증서
    ssl_certificate /etc/letsencrypt/live/storage.studyspot.kr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/storage.studyspot.kr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 공통 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # =======================
    # S3 API (9000)
    # =======================
    location / {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # MinIO는 Host Header가 그대로 필요함
        proxy_set_header X-Amz-Content-Sha256 $http_x_amz_content_sha256;
        proxy_set_header X-Amz-Date $http_x_amz_date;

        # 업로드 관련 large request 대비
        client_max_body_size 50M;
    }
}

server {
    listen 443 ssl http2;
    server_name tmp.studyspot.kr;

    # TLS 인증서
    ssl_certificate /etc/letsencrypt/live/tmp.studyspot.kr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/tmp.studyspot.kr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 공통 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # 임시 정적 이미지 서버
    location / {
        proxy_pass http://localhost:8089;  # nginx image-server 컨테이너 포트
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

}
